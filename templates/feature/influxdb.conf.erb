// managed by puppet

library "perfdata"

object InfluxdbWriter "influxdb" {
  host = "<%= scope['icinga2::feature::influxdb::host'] %>"
  port = <%= scope['icinga2::feature::influxdb::port'] %>
  database = "<%= scope['icinga2::feature::influxdb::database'] %>"
<% if ! [:undef, nil, ''].include?(scope.lookupvar('icinga2::feature::influxdb::username')) -%>
  username = "<%= scope['icinga2::feature::influxdb::username'] %>"
<% end -%>
<% if ! [:undef, nil, ''].include?(scope.lookupvar('icinga2::feature::influxdb::password')) -%>
  password = "<%= scope['icinga2::feature::influxdb::password'] %>"
<% end -%>
<% if scope.lookupvar('icinga2::feature::influxdb::ssl') -%>
  ssl_enable = true
<% case scope.lookupvar('icinga2::feature::influxdb::ssl') 
  when "puppet" -%>
  ssl_ca_cert = "<%= scope.lookupvar('icinga2::feature::influxdb::ssl_dir') %>/ca.crt"
  ssl_cert = "<%= scope.lookupvar('icinga2::feature::influxdb::ssl_dir') %>/<%= scope.lookupvar('icinga2::feature::influxdb::node_name') %>.crt"
  ssl_key = "<%= scope.lookupvar('icinga2::feature::influxdb::ssl_dir') %>/<%= scope.lookupvar('icinga2::feature::influxdb::node_name') %>.key"
<% end -%>
<% end -%>
  enable_send_thresholds = <%= scope['icinga2::feature::influxdb::enable_send_thresholds'] %>
  enable_send_metadata = <%= scope['icinga2::feature::influxdb::enable_send_metadata'] %>
<% if scope.lookupvar('icinga2::feature::influxdb::flush_interval') -%>
  flush_interval = <%= scope['icinga2::feature::influxdb::flush_interval'] %>
<% end -%>
<% if scope.lookupvar('icinga2::feature::influxdb::flush_interval') -%>
  flush_threshold = <%= scope['icinga2::feature::influxdb::flush_threshold'] %>
<% end -%>

  host_template = {
    measurement = "<%= scope['icinga2::feature::influxdb::host_measurement'] %>"
    tags = {
<% scope['icinga2::feature::influxdb::host_tags'].keys.sort.each do |k, v| -%>
      <%= k %> = "<%= scope['icinga2::feature::influxdb::host_tags'][k] %>"
<% end -%>
    }
  }

  service_template = {
    measurement = "<%= scope['icinga2::feature::influxdb::service_measurement'] %>"
    tags = {
<% scope['icinga2::feature::influxdb::service_tags'].keys.sort.each do |k, v| -%>
      <%= k %> = "<%= scope['icinga2::feature::influxdb::service_tags'][k] %>"
<% end -%>
    }
  }

}
